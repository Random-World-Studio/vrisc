# vrisc

只运行于操作系统上的虚拟CPU架构。

## 中断

中断是提供给软件开发者以处理机器异常以及接收用户输入的机制。

触发中断的条件有以下两种：

* 机器异常
* 外部设备通信

中断产生后，机器将ip存于x0寄存器，flg存于x1寄存器，随后机器陷入内核态并关闭中断使能标志位。

使用`iret`从中断返回，返回时将从x0和x1寄存器恢复ip和flg。

## io

在机器中，使用`in`和`out`指令访问`0`~`63`共64个端口。

## 指令集

### 基本指令集

基本指令集占有`0`~`63`的指令编码码位，提供处理器管理指令以及最基本且必需的运算和寄存器、储存器管理指令。

编号|指令格式|编码|指令名|说明
:-:|:-|:-|:-|:-
0       |nop                 |00                                    |空指令         |暂停CPU直到中断产生
1       |add r1, r2, r3      |01 r1[4],r2[4] r3[4]                  |加法
2       |sub r1, r2, r3      |02 r1[4],r2[4] r3[4]                  |减法
3       |inc r1              |03 r1[4]                              |自增1
4       |dec r1              |04 r2[4]                              |自减1
5       |cmp r1, r2          |05 r1[4],r2[4]                        |比较
6       |and r1, r2, r3      |06 r1[4],r2[4] r3[4]                  |与运算
7       |or r1, r2, r3       |07 r1[4],r2[4] r3[4]                  |或运算
8       |not r1, r2          |08 r1[4],r2[4]                        |非运算
9       |xor r1, r2, r3      |09 r1[4],r2[4] r3[4]                  |异或运算
10      |jc imm              |0a 16/32/64[4],cond[4] imm[16/32/64]  |指令跳转
11      |c imm               |0b 16/32/64[4],cond[4] imm[16/32/64]  |函数调用
12      |r                   |0c                                    |从函数返回
13      |ir imm              |0d mod[8]                             |从中断返回
14      |sysc                |0e                                    |陷入内核态
15      |sysr                |0f                                    |跳回用户态
16      |loop r, imm         |10 r1[8],imm[32]                      |条件循环       |r为非零时跳转到相对地址imm处，并将r自减
17      |chl r1, r2          |11 r1[4],r2[4]                        |左位移        |将r2左移r1位
18      |chr r1, r2          |12 r1[4],r2[4]                        |右位移
19      |rol r1, r2          |13 r1[4],r2[4]                        |左旋
20      |ror r1, r2          |14 r1[4],r2[4]                        |右旋
21      |ldi imm, r          |15 8/16/32/64[4],r[4] imm[8/16/32/64] |加载立即数
22      |ldm r1, r2          |16 r1[4],r2[4]                        |从内存加载      |将r1所指的内存处的数据加载到r2中
23      |stm r1, r2          |17 r1[4],r2[4]                        |保存到内存      |将r1的内容保存到r2所指的内存中
24      |ei                  |18                                    |使能中断
25      |di                  |19                                    |关闭中断
26      |ep                  |1a                                    |使能分页
27      |dp                  |1b                                    |关闭分页
28      |mv r1/m1,r2/m2      |1c mvflg[8] r1[4],r2[4]               |移动数据       |将r1移动至r2
29      |livt r              |1d r[8]                               |加载中断向量表
30      |lkpt r              |1e r[8]                               |加载内核态页表
31      |lupt r              |1f r[8]                               |加载用户态页表
32      |lsrg r1, r2         |20 r[8]                               |加载堆栈寄存器组的寄存器
33      |ssrg r1, r2         |21 r[8]                               |保存堆栈寄存器组的寄存器
34      |initext r           |22 r[8]                               |初始化扩展指令集  |r为指令集代码
35      |destext             |23                                    |销毁扩展指令集
36      |in imm/r1, r2       |24 r2[4],mvflg[4] imm[8]/r1[4]        |端口输入       |第一个参数是端口号，第二个是储存输入的寄存器
37      |out r1, imm/r2      |25 r1[4],mvflg[4] imm[8]/r2[4]        |端口输出       |第一个是储存输入的寄存器，第二个参数是端口号

[cond]条件码|说明
:-:|:-
0       |non
1       |equal
2       |bigger
3       |smaller
4       |n-equal
5       |n-bigger
6       |n-smaller
7       |higher
8       |lower
9       |n-higher
a       |n-lower
b       |overflow
c       |zero

[mod]中断返回模式码|说明
:-:|:-
0       |panic
1       |retry
2       |skip

[mvflg]移动指令标志位|说明
:-:|:-
0       |r1,r2
1       |r,m
2       |m,r
3       |m1,m2

### 扩展指令集

vrisc通过扩展指令集来提供如`基本数学运算扩展`、`单指令多数据扩展`等额外功能。

扩展指令集需要用`initext`与`destext`指令对进行加载和卸载操作。

扩展指令集共享库的文件名格式：libvriscext`指令集id`.`指令集名`.so

#### 基本数学运算扩展(bae)

#### 高级向量扩展(ave)

#### 单指令多数据扩展(simde)

## 设备抽象

提供了设备`/dev/vrisc-x`，使用协议库访问设备。
